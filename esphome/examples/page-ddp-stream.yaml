# Â© Copyright 2025 Stuart Parmenter
# SPDX-License-Identifier: MIT

# =========================================
# DDP Stream Page (LVGL, ESP-IDF only)
# Tested with ESPHome 2025.8
# =========================================

substitutions:
  WS_DDP_HOST: "192.168.1.200"
  WS_DDP_PORT: "8788"
  DDP_PORT: "4048"
  DEFAULT_VIDEO_SRC: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"   # or "mario.gif" or https://... / file:///sd/... etc.
  CANVAS_WIDTH: "64"
  CANVAS_HEIGHT: "64"
  OUT_ID: "1"

external_components:
  - source: github://stuartparmenter/lvgl-ddp-stream@main  # Use @v0.4.2 or specific version for production
    components: [ddp_stream, ws_ddp_control]

# UDP DDP sink + canvas bindings (no w/h required here)
ddp_stream:
  id: ddp
  port: ${DDP_PORT}
  streams:
    - id: stream_${OUT_ID}
      canvas: "canvas64"
      # stream: auto-generated (starts at 2)
    # - id: stream_2
    #   canvas: "canvas32"
    #   # stream: auto-generated

# -----------------------------
# WebSocket control
# -----------------------------
ws_ddp_control:
  id: ws
  ws_host: ${WS_DDP_HOST}
  ws_port: ${WS_DDP_PORT}
  device_id: "esp32-ddp"        # Optional device identifier
  ddp: ddp
  outputs:
    - id: output_${OUT_ID}
      ddp_stream: stream_${OUT_ID}  # References the ddp_stream's stream ID
      src: ${DEFAULT_VIDEO_SRC}
      # width/height optional; if omitted, auto from canvas
      # width: 64
      # height: 64
      # format: rgb888          # Optional: rgb888, rgb565, rgb565le, rgb565be
      # pace: 0
      # ema: 0.0
      # expand: auto
      # loop: true
      # hw: auto
    # - id: output_2
    #   ddp_stream: stream_2
    #   src: ${VIDEO_SRC_2}

# -----------------------------
# LVGL page with a single canvas
# -----------------------------
lvgl:
  pages:
    - id: ddp_video
      widgets:
        - canvas:
            id: canvas64
            width: ${CANVAS_WIDTH}
            height: ${CANVAS_HEIGHT}
      on_load:
        then:
          - lambda: |-
              id(ws).connect();
              id(output_${OUT_ID}).start();
      on_unload:
        then:
          - lambda: |-
              id(output_${OUT_ID}).stop();
              id(ws).disconnect();

# -----------------------------
# Runtime source change
# -----------------------------
text:
  - platform: template
    id: video_src_ctl
    name: "DDP Video Source"
    optimistic: true
    initial_value: ${DEFAULT_VIDEO_SRC}
    mode: text
    on_value:
      then:
        - ws_ddp_control.set_src:
            id: output_${OUT_ID}  # Reference the output ID directly
            src: !lambda "return x;"

